@model List<TuyetDang.MyVetTracer.Entity.Veterinarian>
@{
    ViewData["Title"] = "Veterinarians Management";
}

@section Styles {
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="~/css/veterinarian.css" />
}

<div class="vet-container fade-in">
    <div class="vet-header">
        <h2><i class="bi bi-hospital"></i></h2>
        <a href="@Url.Action("Create", "Veterinarian")" class="btn vet-btn vet-btn-success">
            <i class="bi bi-plus-circle"></i> Add New Veterinarian
        </a>
    </div>

    <!-- Dashboard Stats -->
    <div class="vet-stats-container mb-4">
        <div class="row g-3">
            <div class="col-md-3">
                <div class="vet-stat-card bg-primary text-white">
                    <div class="vet-stat-icon"><i class="bi bi-people-fill"></i></div>
                    <div class="vet-stat-info">
                        <h3>@ViewBag.TotalVeterinarians</h3>
                        <p>Total Veterinarians</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="vet-stat-card bg-success text-white">
                    <div class="vet-stat-icon"><i class="bi bi-check-circle-fill"></i></div>
                    <div class="vet-stat-info">
                        <h3>@ViewBag.VerifiedVeterinarians</h3>
                        <p>Verified Veterinarians</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="vet-stat-card bg-warning text-dark">
                    <div class="vet-stat-icon"><i class="bi bi-hourglass-split"></i></div>
                    <div class="vet-stat-info">
                        <h3>@ViewBag.PendingVeterinarians</h3>
                        <p>Pending Verification</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="vet-stat-card bg-info text-white">
                    <div class="vet-stat-icon"><i class="bi bi-heart-fill"></i></div>
                    <div class="vet-stat-info">
                        <h3>@ViewBag.TotalPets</h3>
                        <p>Total Pets</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Search and Filter Section -->
    <div class="vet-search-container">
        <form id="searchForm" method="get" class="row g-3">
            <div class="col-md-4">
                <div class="input-group">
                    <span class="input-group-text"><i class="bi bi-search"></i></span>
                    <input type="text" id="searchTerm" name="searchTerm" class="form-control"
                        placeholder="Search by name, email, or qualification..." value="@ViewBag.CurrentSearch">
                </div>
            </div>
            <div class="col-md-3">
                <select id="filterQualification" name="qualification" class="form-select">
                    <option value="">All Qualifications</option>
                    @if (ViewBag.Qualifications != null)
                    {
                        foreach (var qual in ViewBag.Qualifications)
                        {
                            if (!string.IsNullOrEmpty(qual.Qualification))
                            {
                                <option value="@qual.Qualification"
                                    selected="@(ViewBag.CurrentQualification == qual.Qualification)">
                                    @qual.Qualification
                                </option>

                            }
                        }
                    }
                </select>
            </div>
            <div class="col-md-3">
                <select id="sortBy" name="sortBy" class="form-select">
                    <option value="name" selected="@(ViewBag.CurrentSortBy == "name")">Sort by Name (A-Z)</option>
                    <option value="name-desc" selected="@(ViewBag.CurrentSortBy == "name-desc")">Sort by Name (Z-A)
                    </option>
                    <option value="date" selected="@(ViewBag.CurrentSortBy == "date")">Sort by Date</option>
                    <option value="pets" selected="@(ViewBag.CurrentSortBy == "pets")">Sort by Pets Count</option>

                </select>
            </div>
            <div class="col-md-2">
                <button type="submit" class="btn vet-btn vet-btn-primary w-100">Apply</button>
            </div>
            <input type="hidden" name="page" value="1" /> <!-- Reset to page 1 when filtering -->
        </form>
    </div>

    <!-- Toggle View Buttons -->
    <div class="mb-4">
        <div class="btn-group" role="group">
            <button type="button" class="btn btn-outline-primary" id="tableViewBtn"><i class="bi bi-table"></i> Table
                View</button>
            <button type="button" class="btn btn-outline-primary active" id="cardViewBtn"><i
                    class="bi bi-grid-3x3-gap"></i> Card View</button>
        </div>
    </div>

    <!-- Card View -->
    <div id="cardView" class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4 mb-4">
        @if (Model != null && Model.Count > 0)
        {
            foreach (var vet in Model)
            {
                <div class="col fade-in">
                    <div class="vet-card">
                        <div class="vet-card-header">
                            <h5 class="mb-0">@vet.FullName</h5>
                            <small>@vet.UserName</small>
                        </div>
                        <div class="text-center position-relative">
                            <img src="@(string.IsNullOrEmpty(vet.Img) ? "/img/default-vet.jpg" : vet.Img)" alt="@vet.FullName"
                                class="vet-card-img mt-3 js-avatar" data-vet-id="@vet.IdVetUser" />
                            <span
                                class="position-absolute top-0 end-0 translate-middle badge rounded-pill bg-success mt-4 me-2">
                                @(vet.Authentication == 1 ? "Verified" : "Pending")
                            </span>
                        </div>
                        <div class="vet-card-body">
                            <div class="mb-2">
                                <span class="vet-badge vet-badge-primary">@vet.Qualification</span>
                                <span class="vet-badge vet-badge-success">@(vet.Pets != null ? vet.Pets.Count : 0) Pets</span>
                                
                                @{
                                  bool isBusy = vet.Appointments != null &&
                                    vet.Appointments.Any(a =>
                                  DateTime.TryParse(a.Time, out var time) &&
                                   time.Date == DateTime.Now.Date);
        }

<span class="vet-status @(isBusy ? "vet-status-busy" : "vet-status-available") float-end">
    @(isBusy ? "Busy" : "Available")
</span>
                            </div>
                            
                            <p><i class="bi bi-envelope"></i> @vet.Email</p>
                            <p><i class="bi bi-telephone"></i> @vet.PhoneNum</p>
                            <p><i class="bi bi-building"></i> @vet.NameOfConsultingRoom</p>
                            <p><i class="bi bi-geo-alt"></i> @vet.ClinicAddress</p>
                            
                            <!-- Toggle buttons -->
                            <div class="mt-3">
                                <button type="button" class="vet-toggle-btn js-toggle-pets" data-target="pets-@vet.IdVetUser">
                                    <i class="bi bi-chevron-right"></i> Show Pets (@(vet.Pets != null ? vet.Pets.Count : 0))
                                </button>
                                <div id="pets-@vet.IdVetUser" class="vet-toggle-section">
                                    <div class="vet-toggle-content">
                                        @if (vet.Pets != null && vet.Pets.Count > 0)
                                        {
                                            foreach (var pet in vet.Pets)
                                            {
                                                <div class="vet-pet-item">
                                                    <img src="@(string.IsNullOrEmpty(pet.Img) ? "/img/default-pet.jpg" : pet.Img)" alt="@pet.PetName" class="vet-pet-img" />
                                                    <div class="vet-pet-info">
                                                        <p class="vet-pet-name">@pet.PetName</p>
                                                        <p class="vet-pet-type">@pet.PetType, @pet.Age years old</p>
                                                    </div>
                                                </div>
                                            }
                                        }
                                        else
                                        {
                                            <p class="text-muted">No pets assigned yet.</p>
                                        }
                                    </div>
                                </div>
                            </div>
                            
                            <div>
                                <button type="button" class="vet-toggle-btn js-toggle-appointments" data-target="appointments-@vet.IdVetUser">
                                    <i class="bi bi-chevron-right"></i> Show Appointments (@(vet.Appointments != null ? vet.Appointments.Count : 0))
                                </button>
                                <div id="appointments-@vet.IdVetUser" class="vet-toggle-section">
                                    <div class="vet-toggle-content">
                                        @if (vet.Appointments != null && vet.Appointments.Count > 0)
                                        {
                                            foreach (var appointment in vet.Appointments.OrderBy(a => a.Time))
                                            {
                                                <div class="vet-appointment-item">
                                                    <div class="vet-appointment-info">
                                                        <p class="vet-appointment-time">@appointment.Time</p>
                                                        <p class="vet-appointment-pet">Pet: @(appointment.Pet?.PetName ?? "Not specified")</p>
                                                    </div>
                                                    <span class="vet-badge @(appointment.IsConfirmed == 1 ? "vet-badge-success" : "vet-badge-primary")">
                                                        @(appointment.IsConfirmed == 1 ? "Confirmed" : "Pending")
                                                    </span>
                                                </div>
                                            }
                                        }
                                        else
                                        {
                                            <p class="text-muted">No appointments scheduled.</p>
                                        }
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="vet-card-footer d-flex justify-content-between">
                            <a href="@Url.Action("Edit", "Veterinarian", new { id = vet.IdVetUser })"
                                class="btn vet-btn vet-btn-primary">
                                <i class="bi bi-pencil-square"></i> Edit
                            </a>
                            <button type="button" class="btn vet-btn vet-btn-danger" data-bs-toggle="modal"
                                data-bs-target="#deleteModal-@vet.IdVetUser">
                                <i class="bi bi-trash"></i> Delete
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Delete Confirmation Modal -->
                <div class="modal fade" id="deleteModal-@vet.IdVetUser" tabindex="-1"
                    aria-labelledby="deleteModalLabel-@vet.IdVetUser" aria-hidden="true">
                    <div class="modal-dialog modal-dialog-centered vet-modal-content">
                        <div class="modal-content">
                            <div class="modal-header vet-modal-header">
                                <h5 class="modal-title" id="deleteModalLabel-@vet.IdVetUser">Confirm Deletion</h5>
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                                    aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <p>Are you sure you want to delete <strong>@vet.FullName</strong>?</p>
                                <p class="text-danger"><small>This action cannot be undone.</small></p>
                            </div>
                            <div class="modal-footer vet-modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                <a href="@Url.Action("Delete", "Veterinarian", new { id = vet.IdVetUser })"
                                    class="btn vet-btn-danger">Delete</a>
                            </div>
                        </div>
                    </div>
                </div>
            }
        }
        else
        {
            <div class="col-12 text-center py-5">
                <div class="alert alert-info">
                    <i class="bi bi-info-circle-fill me-2"></i> No veterinarians found.
                </div>
            </div>
        }
    </div>

    <!-- Table View (Hidden by Default) -->
    <div id="tableView" class="mb-4" style="display: none;">
        <div class="table-responsive">
            <table class="table vet-table">
                <thead>
                    <tr>
                        <th scope="col">Avatar</th>
                        <th scope="col">Full Name</th>
                        <th scope="col">Email</th>
                        <th scope="col">Phone</th>
                        <th scope="col">Consulting Room</th>
                        <th scope="col">Qualification</th>
                        <th scope="col">Pets</th>
                        <th scope="col">Status</th>
                        <th scope="col" class="text-center">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    @if (Model != null && Model.Count > 0)
                    {
                        foreach (var vet in Model)
                        {
                            <tr data-vet-id="@vet.IdVetUser" class="vet-table-row">
                                <td>
                                    <img src="@(string.IsNullOrEmpty(vet.Img) ? "/img/default-vet.jpg" : vet.Img)"
                                        alt="@vet.FullName" width="50" height="50"
                                        class="js-avatar" data-vet-id="@vet.IdVetUser"
                                        style="object-fit: cover; border-radius: 50%; cursor: pointer;" />
                                </td>
                                <td>@vet.FullName</td>
                                <td>@vet.Email</td>
                                <td>@vet.PhoneNum</td>
                                <td>@vet.NameOfConsultingRoom</td>
                                <td><span class="vet-badge vet-badge-primary">@vet.Qualification</span></td>
                                <td>
                                    <span class="vet-badge vet-badge-success">@(vet.Pets != null ? vet.Pets.Count : 0)</span>
                                </td>
                                <td>
                                    <span class="vet-status @(vet.Appointments != null && vet.Appointments.Any(a => a.Time.Contains(DateTime.Now.ToString("yyyy-MM-dd"))) ? "vet-status-busy" : "vet-status-available")">
                                        @(vet.Appointments != null && vet.Appointments.Any(a => a.Time.Contains(DateTime.Now.ToString("yyyy-MM-dd"))) ? "Busy" : "Available")
                                    </span>
                                </td>
                                <td class="text-center">
                                    <div class="d-flex align-items-center justify-content-center">
                                        <a href="@Url.Action("Edit", "Veterinarian", new { id = vet.IdVetUser })" class="btn btn-sm vet-btn-primary me-2">
                                            <i class="bi bi-pencil-square"></i>
                                        </a>
                                        <button type="button" class="btn btn-sm vet-btn-danger me-2" data-bs-toggle="modal" data-bs-target="#deleteModal-@vet.IdVetUser">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                        <button type="button" class="table-toggle-arrow js-toggle-row" data-vet-id="@vet.IdVetUser">
                                            <i class="bi bi-chevron-right"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            <tr id="expanded-row-@vet.IdVetUser" class="expanded-row" style="display: none;">
                                <td colspan="9">
                                    <div class="expanded-content">
                                        <div class="expanded-section">
                                            <div class="expanded-section-title">
                                                <i class="bi bi-heart-pulse"></i> Pets (@(vet.Pets != null ? vet.Pets.Count : 0))
                                            </div>
                                            <div class="expanded-pets">
                                                @if (vet.Pets != null && vet.Pets.Count > 0)
                                                {
                                                    foreach (var pet in vet.Pets)
                                                    {
                                                        <div class="vet-pet-item">
                                                            <img src="@(string.IsNullOrEmpty(pet.Img) ? "/img/default-pet.jpg" : pet.Img)" alt="@pet.PetName" class="vet-pet-img" />
                                                            <div class="vet-pet-info">
                                                                <p class="vet-pet-name">@pet.PetName</p>
                                                                <p class="vet-pet-type">@pet.PetType, @pet.Age years old</p>
                                                            </div>
                                                            <div class="vet-pet-tooltip">
                                                                <div class="vet-tooltip-header">@pet.PetName</div>
                                                                <div class="vet-tooltip-info">
                                                                    <p><strong>Type:</strong> @pet.PetType</p>
                                                                    <p><strong>Age:</strong> @pet.Age years</p>
                                                                    <p><strong>Sex:</strong> @pet.Sex</p>
                                                                    <p><strong>Weight:</strong> @pet.Weight kg</p>
                                                                    <p><strong>Height:</strong> @pet.Height cm</p>
                                                                    <p><strong>ID:</strong> @pet.Identification</p>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    }
                                                }
                                                else
                                                {
                                                    <p class="text-muted">No pets assigned yet.</p>
                                                }
                                            </div>
                                        </div>
                                        
                                        <div class="expanded-section">
                                            <div class="expanded-section-title">
                                                <i class="bi bi-calendar-check"></i> Appointments (@(vet.Appointments != null ? vet.Appointments.Count : 0))
                                            </div>
                                            <div class="expanded-appointments">
                                                @if (vet.Appointments != null && vet.Appointments.Count > 0)
                                                {
                                                    foreach (var appointment in vet.Appointments.OrderBy(a => a.Time))
                                                    {
                                                        <div class="vet-appointment-item">
                                                            <div class="vet-appointment-info">
                                                                <p class="vet-appointment-time">@appointment.Time</p>
                                                                <p class="vet-appointment-pet">Pet: @(appointment.Pet?.PetName ?? "Not specified")</p>
                                                            </div>
                                                            <span class="vet-badge @(appointment.IsConfirmed == 1 ? "vet-badge-success" : "vet-badge-primary")">
                                                                @(appointment.IsConfirmed == 1 ? "Confirmed" : "Pending")
                                                            </span>
                                                            <div class="vet-appointment-tooltip">
                                                                <div class="vet-tooltip-header">Appointment Details</div>
                                                                <div class="vet-tooltip-info">
                                                                    <p><strong>Date/Time:</strong> @appointment.Time</p>
                                                                    <p><strong>Pet:</strong> @(appointment.Pet?.PetName ?? "Not specified")</p>
                                                                    <p><strong>Pet Type:</strong> @(appointment.Pet?.PetType ?? "Not specified")</p>
                                                                    <p><strong>Status:</strong> @(appointment.IsConfirmed == 1 ? "Confirmed" : "Pending")</p>
                                                                    <p><strong>ID:</strong> @appointment.IdAppointment</p>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    }
                                                }
                                                else
                                                {
                                                <p class="text-muted">No appointments scheduled.</p>
                                            }
                                            </div>
                                         </div>
                                     </div>
                                 </td>
                             </tr>
                        }
                    }
                    else
                    {
                        <tr>
                            <td colspan="8" class="text-center">No veterinarians found.</td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>

    <!-- Pagination -->
    @if (ViewBag.TotalPages > 1)
    {
        <nav aria-label="Page navigation" class="vet-pagination">
            <ul class="pagination">
                <!-- Previous Page -->
                <li class="page-item @(!ViewBag.HasPreviousPage ? "disabled" : "")">
                    <a class="page-link"
                        href="@Url.Action("VeterinarianIndex", new { searchTerm = ViewBag.CurrentSearch, qualification = ViewBag.CurrentQualification, sortBy = ViewBag.CurrentSortBy, page = ViewBag.CurrentPage - 1 })"
                        tabindex="-1" aria-disabled="@(!ViewBag.HasPreviousPage)">
                        <i class="bi bi-chevron-left"></i> Previous
                    </a>
                </li>

                <!-- Page Numbers -->
                @{
                    int startPage = Math.Max(1, ViewBag.CurrentPage - 2);
                    int endPage = Math.Min(ViewBag.TotalPages, startPage + 4);

                    // Adjust start page if we're near the end
                    if (endPage - startPage < 4 && startPage > 1)
                    {
                        startPage = Math.Max(1, endPage - 4);
                    }
                }

                @for (int i = startPage; i <= endPage; i++)
                {
                    <li class="page-item @(i == ViewBag.CurrentPage ? "active" : "")">
                        <a class="page-link"
                            href="@Url.Action("VeterinarianIndex", new { searchTerm = ViewBag.CurrentSearch, qualification = ViewBag.CurrentQualification, sortBy = ViewBag.CurrentSortBy, page = i })">
                            @i
                        </a>
                    </li>
                }

                <!-- Next Page -->
                <li class="page-item @(!ViewBag.HasNextPage ? "disabled" : "")">
                    <a class="page-link"
                        href="@Url.Action("VeterinarianIndex", new { searchTerm = ViewBag.CurrentSearch, qualification = ViewBag.CurrentQualification, sortBy = ViewBag.CurrentSortBy, page = ViewBag.CurrentPage + 1 })">
                        Next <i class="bi bi-chevron-right"></i>
                    </a>
                </li>
            </ul>
        </nav>
    }

    <!-- Results Summary -->
    <div class="vet-results-summary text-muted mb-3">
        <small>Showing page @ViewBag.CurrentPage of @ViewBag.TotalPages (@ViewBag.TotalVeterinarians total
            records)</small>
    </div>
</div>
@if (TempData["SuccessMessage"] != null)
{
    <div class="toast-container position-fixed top-0 end-0 p-3">
        <div id="successToast" class="toast align-items-center text-bg-success border-0" role="alert" aria-live="assertive"
            aria-atomic="true">
            <div class="d-flex">
                <div class="toast-body">
                    @TempData["SuccessMessage"]
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"
                    aria-label="Close"></button>
            </div>
        </div>
    </div>

    <script type="text/javascript">
        window.onload = function () {
            var toastEl = document.getElementById('successToast');
            if (toastEl) {
                var toast = new bootstrap.Toast(toastEl);
                toast.show();
            }
        };
    </script>
}

<!-- Avatar Modal -->
<div id="avatarModal" class="avatar-modal">
    <span class="avatar-modal-close">&times;</span>
    <img class="avatar-modal-content" id="avatarModalImg">
</div>

@section Scripts {
    <script src="~/js/veterinarian.js"></script>
}
