@model List<TuyetDang.MyVetTracer.Entity.Medicine>

@{
    ViewData["Title"] = "Medicine List";
}

@section Styles {
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/chart.js@3.7.0/dist/chart.min.css">
    <link rel="stylesheet" href="~/css/medicine.css" />
}

<div class="medicine-container fade-in">
    <div class="medicine-header">
        <h2><i class="bi bi-capsule"></i> Medicines Management</h2>
        <a href="@Url.Action("Create", "Medicine")" class="btn medicine-btn medicine-btn-success">
            <i class="bi bi-plus-circle"></i> Add New Medicine
        </a>
    </div>

    <!-- Dashboard Stats -->
    <div class="medicine-stats-container mb-4">
        <div class="row g-3">
            <div class="col-md-4">
                <div class="medicine-stat-card bg-primary text-white">
                    <div class="medicine-stat-icon"><i class="bi bi-capsule"></i></div>
                    <div class="medicine-stat-info">
                        <h3>@Model.Count</h3>
                        <p>Total Medicines</p>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="medicine-stat-card bg-success text-white">
                    <div class="medicine-stat-icon"><i class="bi bi-check-circle-fill"></i></div>
                    <div class="medicine-stat-info">
                        <h3>@Model.Count(m => m.Total > 0)</h3>
                        <p>Available</p>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="medicine-stat-card bg-warning text-white">
                    <div class="medicine-stat-icon"><i class="bi bi-exclamation-triangle-fill"></i></div>
                    <div class="medicine-stat-info">
                        <h3>@Model.Count(m => m.Total <= 0)</h3>
                        <p>Out of Stock</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Search and Filter Section -->
    <div class="medicine-search-container mb-4">
        <form id="filterForm" method="get" action="@Url.Action("MedicineIndex", "Medicine")" class="row g-3">
            <div class="col-md-4">
                <div class="input-group">
                    <span class="input-group-text"><i class="bi bi-search"></i></span>
                    <input type="text" class="form-control" placeholder="Search medicine name..." name="searchString" value="@ViewBag.CurrentFilter">
                </div>
            </div>
            <div class="col-md-3">
                <select class="form-select" name="stockFilter">
                    <option value="">All Stock Status</option>
                    <option value="available">Available</option>
                    <option value="outofstock">Out of Stock</option>
                </select>
            </div>
            <div class="col-md-2">
                <button type="submit" class="btn medicine-btn medicine-btn-primary w-100"><i class="bi bi-filter"></i> Apply</button>
            </div>
            <div class="col-md-2">
                <button type="button" id="resetFilters" class="btn medicine-btn medicine-btn-outline-secondary w-100"><i class="bi bi-x-circle"></i> Reset</button>
            </div>
        </form>
    </div>

    <!-- View Toggle Buttons -->
    <div class="mb-4">
        <div class="btn-group" role="group">
            <button id="cardViewBtn" type="button" class="btn medicine-btn medicine-btn-outline-primary active">
                <i class="bi bi-grid-3x3-gap"></i> Card View
            </button>
            <button id="tableViewBtn" type="button" class="btn medicine-btn medicine-btn-outline-primary">
                <i class="bi bi-table"></i> Table View
            </button>
        </div>
    </div>

    <!-- Card View -->
    <div id="cardView" class="row g-4">
        @foreach (var medicine in Model)
        {
            <div class="col-md-6 col-lg-4">
                <div class="medicine-card">
                    <div class="medicine-card-header">
                        <h3 class="medicine-name">@medicine.MedName</h3>
                        <span class="medicine-id">#@medicine.IdMed</span>
                    </div>
                    <div class="medicine-card-body">
                        <div class="medicine-info">
                            <div class="medicine-info-item">
                                <span class="medicine-info-label">Amount:</span>
                                <span class="medicine-info-value">@medicine.Amount</span>
                            </div>
                            <div class="medicine-info-item">
                                <span class="medicine-info-label">Dose:</span>
                                <span class="medicine-info-value">@medicine.Dose</span>
                            </div>
                            <div class="medicine-info-item">
                                <span class="medicine-info-label">Total:</span>
                                <span class="medicine-info-value @(medicine.Total <= 0 ? "text-danger" : "text-success")">@medicine.Total</span>
                            </div>
                            <div class="medicine-info-item">
                                <span class="medicine-info-label">Notice:</span>
                                <span class="medicine-info-value">@medicine.Notice</span>
                            </div>
                        </div>

                        <!-- Expandable Pet Section -->
                        <div class="medicine-expandable-section">
                            <div class="medicine-expandable-header" data-bs-toggle="collapse" data-bs-target="#petSection@(medicine.IdMed)">
                                <span><i class="bi bi-person-badge"></i> Pet Information</span>
                                <i class="bi bi-chevron-down"></i>
                            </div>
                            <div id="petSection@(medicine.IdMed)" class="collapse medicine-expandable-content">
                                @if (medicine.Pet != null)
                                {
                                    <div class="medicine-pet-info">
                                        <div class="medicine-avatar-container">
                                            <img src="@(string.IsNullOrEmpty(medicine.Pet.Img) ? "/images/default-pet.png" : medicine.Pet.Img)" 
                                                 alt="@medicine.Pet.PetName" class="medicine-avatar clickable-avatar">
                                        </div>
                                        <div class="medicine-pet-details">
                                            <h4>@medicine.Pet.PetName</h4>
                                            <p><strong>Type:</strong> @medicine.Pet.PetType</p>
                                            <p><strong>Age:</strong> @medicine.Pet.Age years</p>
                                            <p><strong>Weight:</strong> @medicine.Pet.Weight kg</p>
                                        </div>
                                    </div>
                                }
                                else
                                {
                                    <p>No pet information available</p>
                                }
                            </div>
                        </div>

                        <!-- Expandable Owner Section -->
                        <div class="medicine-expandable-section">
                            <div class="medicine-expandable-header" data-bs-toggle="collapse" data-bs-target="#ownerSection@(medicine.IdMed)">
                                <span><i class="bi bi-person"></i> Owner Information</span>
                                <i class="bi bi-chevron-down"></i>
                            </div>
                            <div id="ownerSection@(medicine.IdMed)" class="collapse medicine-expandable-content">
                                @if (medicine.Pet?.OwnerUser != null)
                                {
                                    <div class="medicine-owner-info">
                                        <div class="medicine-avatar-container">
                                            <img src="@(string.IsNullOrEmpty(medicine.Pet.OwnerUser.Img) ? "/images/default-user.png" : medicine.Pet.OwnerUser.Img)" 
                                                 alt="@medicine.Pet.OwnerUser.FullName" class="medicine-avatar clickable-avatar">
                                        </div>
                                        <div class="medicine-owner-details">
                                            <h4>@medicine.Pet.OwnerUser.FullName</h4>
                                            <p><strong>Email:</strong> @medicine.Pet.OwnerUser.Email</p>
                                            <p><strong>Phone:</strong> @medicine.Pet.OwnerUser.PhoneNum</p>
                                        </div>
                                    </div>
                                }
                                else
                                {
                                    <p>No owner information available</p>
                                }
                            </div>
                        </div>

                        <!-- Expandable Veterinarian Section -->
                        <div class="medicine-expandable-section">
                            <div class="medicine-expandable-header" data-bs-toggle="collapse" data-bs-target="#vetSection@(medicine.IdMed)">
                                <span><i class="bi bi-hospital"></i> Veterinarian Information</span>
                                <i class="bi bi-chevron-down"></i>
                            </div>
                            <div id="vetSection@(medicine.IdMed)" class="collapse medicine-expandable-content">
                                @if (medicine.VetUser != null)
                                {
                                    <div class="medicine-vet-info">
                                        <div class="medicine-avatar-container">
                                            <img src="@(string.IsNullOrEmpty(medicine.VetUser.Img) ? "/images/default-vet.png" : medicine.VetUser.Img)" 
                                                 alt="@medicine.VetUser.FullName" class="medicine-avatar clickable-avatar">
                                        </div>
                                        <div class="medicine-vet-details">
                                            <h4>@medicine.VetUser.FullName</h4>
                                            <p><strong>Specialty:</strong> @medicine.VetUser.Experience</p>
                                            <p><strong>Email:</strong> @medicine.VetUser.Email</p>
                                        </div>
                                    </div>
                                }
                                else
                                {
                                    <p>No veterinarian information available</p>
                                }
                            </div>
                        </div>
                    </div>
                    <div class="medicine-card-footer">
                        <div class="medicine-created-date">Created: @medicine.CreatedAt.ToString("MMM dd, yyyy")</div>
                        <div class="medicine-actions">
                            <a href="@Url.Action("Edit", "Medicine", new { id = medicine.IdMed })" class="btn medicine-btn medicine-btn-sm medicine-btn-primary">
                                <i class="bi bi-pencil"></i> Edit
                            </a>
                            <button class="btn medicine-btn medicine-btn-sm medicine-btn-danger delete-medicine" data-id="@medicine.IdMed" data-name="@medicine.MedName">
                                <i class="bi bi-trash"></i> Delete
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        }
    </div>

    <!-- Table View -->
    <div id="tableView" style="display: none;">
        <div class="table-responsive">
            <table class="table table-hover medicine-table">
                <thead class="medicine-table-header">
                    <tr>
                        <th>Id</th>
                        <th>Medicine Name</th>
                        <th>Amount</th>
                        <th>Notice</th>
                        <th>Dose</th>
                        <th>Total</th>
                        <th>Pet</th>
                        <th>Owner</th>
                        <th>Veterinarian</th>
                        <th>Created Date</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
        @if (Model != null && Model.Count > 0)
        {
            foreach (var med in Model)
            {
                <tr>
                    <td>@med.IdMed</td>
                    <td>@med.MedName</td>
                    <td>@med.Amount</td>
                    <td>@med.Notice</td>
                    <td>@med.Dose</td>
                    <td>@med.Total</td>
                    <td>@(med.Pet != null ? med.Pet.PetName : "-")</td>
                    <td>@(med.Pet?.OwnerUser != null ? med.Pet.OwnerUser.FullName : "-")</td>
                    <td>@(med.VetUser != null ? med.VetUser.FullName : "-")</td>
                    <td>@med.CreatedAt</td>
                    <td>
                        <div class="d-flex gap-2">
                            <a href="@Url.Action("Edit", "Medicine", new { id = med.IdMed })" class="btn medicine-btn medicine-btn-sm medicine-btn-primary">
                                <i class="bi bi-pencil"></i> Edit
                            </a>
                            <button class="btn medicine-btn medicine-btn-sm medicine-btn-danger delete-medicine" data-id="@med.IdMed" data-name="@med.MedName">
                                <i class="bi bi-trash"></i> Delete
                            </button>
                        </div>
                    </td>
                </tr>
            }
        }
        else
        {
            <tr>
                <td colspan="9" class="text-center">No medicine found.</td>
            </tr>
        }
    </tbody>
</table>
@if (TempData["SuccessMessage"] != null)
{
    <div class="toast-container position-fixed top-0 end-0 p-3">
        <div id="successToast" class="toast align-items-center text-bg-success border-0" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="d-flex">
                <div class="toast-body">
                    @TempData["SuccessMessage"]
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
        </div>
    </div>

    <script type="text/javascript">
        window.onload = function () {
            var toastEl = document.getElementById('successToast');
            if (toastEl) {
                var toast = new bootstrap.Toast(toastEl);
                toast.show();
            }
        };
    </script>
}