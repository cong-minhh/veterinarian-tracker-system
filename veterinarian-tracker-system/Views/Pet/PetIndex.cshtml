@model List<TuyetDang.MyVetTracer.Entity.Pet>

@{
    ViewData["Title"] = "Pet List";
}

@section Styles {
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="~/css/pet.css" />
}

<div class="pet-container fade-in">
    <div class="pet-header">
        <h2><i class="bi bi-heart"></i> Pets Management</h2>
        <a href="@Url.Action("Create", "Pet")" class="btn pet-btn pet-btn-success">
            <i class="bi bi-plus-circle"></i> Add New Pet
        </a>
    </div>

    <!-- Dashboard Stats -->
    <div class="pet-stats-container mb-4">
        <div class="row g-3">
            <div class="col-md-4">
                <div class="pet-stat-card bg-primary text-white">
                    <div class="pet-stat-icon"><i class="bi bi-heart-fill"></i></div>
                    <div class="pet-stat-info">
                        <h3>@Model.Count</h3>
                        <p>Total Pets</p>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="pet-stat-card bg-success text-white">
                    <div class="pet-stat-icon"><i class="bi bi-calendar-check"></i></div>
                    <div class="pet-stat-info">
                        <h3>@Model.Where(p => p.CreatedAt.Date == DateTime.Today.Date).Count()</h3>
                        <p>New Today</p>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="pet-stat-card bg-info text-white">
                    <div class="pet-stat-icon"><i class="bi bi-people"></i></div>
                    <div class="pet-stat-info">
                        <h3>@Model.Select(p => p.IdOwnerUser).Distinct().Count()</h3>
                        <p>Unique Owners</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Search and Filter Section -->
    <div class="pet-search-container mb-4">
        <form id="filterForm" method="get" action="@Url.Action("PetIndex", "Pet")" class="row g-3">
            <div class="col-md-4">
                <div class="input-group">
                    <span class="input-group-text"><i class="bi bi-search"></i></span>
                    <input type="text" class="form-control" placeholder="Search by name, type, ID, owner..." name="searchString" value="@ViewBag.CurrentFilter">
                </div>
            </div>
            <div class="col-md-3">
                <select class="form-select" name="sortOrder">
                    <option value="">Sort by...</option>
                 <option value="name_asc" selected="@(ViewBag.CurrentSort == "name_asc")">Name (A-Z)</option>
<option value="name_desc" selected="@(ViewBag.CurrentSort == "name_desc")">Name (Z-A)</option>
<option value="type_asc" selected="@(ViewBag.CurrentSort == "type_asc")">Type (A-Z)</option>
<option value="type_desc" selected="@(ViewBag.CurrentSort == "type_desc")">Type (Z-A)</option>
<option value="age_asc" selected="@(ViewBag.CurrentSort == "age_asc")">Age (Youngest)</option>
<option value="age_desc" selected="@(ViewBag.CurrentSort == "age_desc")">Age (Oldest)</option>
<option value="date_asc" selected="@(ViewBag.CurrentSort == "date_asc")">Date (Oldest)</option>
<option value="date_desc" selected="@(ViewBag.CurrentSort == "date_desc")">Date (Newest)</option>

                </select>
            </div>
            <div class="col-md-3">
                <button type="submit" class="btn pet-btn pet-btn-primary w-100"><i class="bi bi-filter"></i> Apply Filters</button>
            </div>
            <div class="col-md-2">
                <button type="button" id="resetFilters" class="btn pet-btn pet-btn-outline-secondary w-100"><i class="bi bi-x-circle"></i> Reset</button>
            </div>
        </form>
    </div>

    <!-- View Toggle Buttons -->
    <div class="mb-4">
        <div class="btn-group" role="group">
            <button id="cardViewBtn" type="button" class="btn pet-btn pet-btn-outline-primary active">
                <i class="bi bi-grid-3x3-gap"></i> Card View
            </button>
            <button id="tableViewBtn" type="button" class="btn pet-btn pet-btn-outline-primary">
                <i class="bi bi-table"></i> Table View
            </button>
        </div>
    </div>

    <!-- Card View -->
    <div id="cardView" class="row g-4 mb-4">
        @if (Model != null && Model.Count > 0)
        {
            foreach (var pet in Model)
            {
                <div class="col-md-6 col-lg-4">
                    <div class="pet-card">
                        <div class="pet-card-header">
                            <h5>@pet.PetName</h5>
                            <span class="pet-badge">@pet.PetType</span>
                        </div>
                        <div class="pet-card-img text-center">
                            <img src="@pet.Img" alt="@pet.PetName" class="pet-avatar-img">
                        </div>
                        <div class="pet-card-body">
                            <div class="mb-3">
                                <p><i class="bi bi-calendar"></i> Age: @pet.Age years</p>
                                <p><i class="bi bi-gender-ambiguous"></i> Sex: @pet.Sex</p>
                                <p><i class="bi bi-rulers"></i> Size: @pet.Weight kg, @pet.Height cm</p>
                                <p><i class="bi bi-fingerprint"></i> ID: @pet.Identification</p>
                            </div>
                            
                            <div class="mb-3">
                                <button class="owner-toggle-btn" data-target="ownerSection-@pet.IdPet">
                                    <i class="bi bi-chevron-right"></i> Owner
                                </button>
                                <div id="ownerSection-@pet.IdPet" class="owner-toggle-section">
                                    @if (pet.OwnerUser != null)
                                    {
                                        <div class="owner-toggle-content">
                                            <div class="owner-item">
                                                <img src="@pet.OwnerUser.Img" alt="@pet.OwnerUser.FullName" class="owner-item-img">
                                                <div class="owner-item-info">
                                                    <h6>@pet.OwnerUser.FullName</h6>
                                                    <p>@pet.OwnerUser.Email | @pet.OwnerUser.PhoneNum</p>
                                                </div>
                                            </div>
                                        </div>
                                    }
                                    else
                                    {
                                        <div class="owner-toggle-content">
                                            <p class="text-muted">No owner information</p>
                                        </div>
                                    }
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <button class="appointment-toggle-btn" data-target="appointmentSection-@pet.IdPet">
                                    <i class="bi bi-chevron-right"></i> Appointments (@(pet.Appointments != null ? pet.Appointments.Count : 0))
                                </button>
                                <div id="appointmentSection-@pet.IdPet" class="appointment-toggle-section">
                                    @if (pet.Appointments != null && pet.Appointments.Count > 0)
                                    {
                                        <div class="appointment-toggle-content">
                                            @foreach (var appointment in pet.Appointments.OrderByDescending(a => a.Time).Take(3))
                                            {
                                                <div class="appointment-item">
                                                    <div class="appointment-item-date">
                                                        <span class="date-day">@appointment.Time</span>
                                                        <span class="date-month">@appointment.Time</span>
                                                    </div>
                                                    <div class="appointment-item-info">
                                                        <h6>@appointment.Time</h6>
                                                        <p>@(appointment.VetUser != null ? appointment.VetUser.FullName : "No vet assigned")</p>
                                                        <span class="appointment-status @(appointment.IsConfirmed == 1 ? "confirmed" : "pending")">@(appointment.IsConfirmed == 1 ? "Confirmed" : "Pending")</span>
                                                    </div>
                                                </div>
                                            }
                                            @if (pet.Appointments.Count > 3)
                                            {
                                                <div class="text-center mt-2">
                                                    <small class="text-muted">+ @(pet.Appointments.Count - 3) more appointments</small>
                                                </div>
                                            }
                                        </div>
                                    }
                                    else
                                    {
                                        <div class="appointment-toggle-content">
                                            <p class="text-muted">No appointments scheduled</p>
                                        </div>
                                    }
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <button class="medicine-toggle-btn" data-target="medicineSection-@pet.IdPet">
                                    <i class="bi bi-chevron-right"></i> Meds (@(pet.Meds != null ? pet.Meds.Count : 0))
                                </button>
                                <div id="medicineSection-@pet.IdPet" class="medicine-toggle-section">
                                    @if (pet.Meds != null && pet.Meds.Count > 0)
                                    {
                                        <div class="medicine-toggle-content">
                                            @foreach (var medicine in pet.Meds.OrderByDescending(m => m.CreatedAt).Take(3))
                                            {
                                                <div class="medicine-item">
                                                    <div class="medicine-item-icon">
                                                        <i class="bi bi-capsule"></i>
                                                    </div>
                                                    <div class="medicine-item-info">
                                                        <h6>@medicine.MedName</h6>
                                                        <p>@medicine.Dose mg | @medicine.Total doses</p>
                                                        <small>@medicine.Notice</small>
                                                    </div>
                                                </div>
                                            }
                                            @if (pet.Meds.Count > 3)
                                            {
                                                <div class="text-center mt-2">
                                                    <small class="text-muted">+ @(pet.Meds.Count - 3) more medicines</small>
                                                </div>
                                            }
                                        </div>
                                    }
                                    else
                                    {
                                        <div class="medicine-toggle-content">
                                            <p class="text-muted">No medicines prescribed</p>
                                        </div>
                                    }
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <button class="vaccine-toggle-btn" data-target="vaccineSection-@pet.IdPet">
                                    <i class="bi bi-chevron-right"></i> Vacs (@(pet.Vacs != null ? pet.Vacs.Count : 0))
                                </button>
                                <div id="vaccineSection-@pet.IdPet" class="vaccine-toggle-section">
                                    @if (pet.Vacs != null && pet.Vacs.Count > 0)
                                    {
                                        <div class="vaccine-toggle-content">
                                            @foreach (var vaccine in pet.Vacs.OrderByDescending(v => v.Date).Take(3))
                                            {
                                                <div class="vaccine-item">
                                                    <div class="vaccine-item-date">
                                                        <span class="date-day">@vaccine.Date</span>
                                                        <span class="date-month">@vaccine.Date</span>
                                                    </div>
                                                    <div class="vaccine-item-info">
                                                        <h6>@vaccine.VacName</h6>
                                                        <p>@vaccine.Dose ml | @vaccine.Total doses</p>
                                                    </div>
                                                </div>
                                            }
                                            @if (pet.Vacs.Count > 3)
                                            {
                                                <div class="text-center mt-2">
                                                    <small class="text-muted">+ @(pet.Vacs.Count - 3) more vaccines</small>
                                                </div>
                                            }
                                        </div>
                                    }
                                    else
                                    {
                                        <div class="vaccine-toggle-content">
                                            <p class="text-muted">No vaccines administered</p>
                                        </div>
                                    }
                                </div>
                            </div>
                        </div>
                        <div class="pet-card-footer">
                            <a href="@Url.Action("Edit", "Pet", new { id = pet.IdPet })" class="btn pet-btn pet-btn-warning me-1">
                                <i class="bi bi-pencil-square"></i> Edit
                            </a>
                            <button class="btn pet-btn pet-btn-danger delete-pet-btn" data-bs-toggle="modal" data-bs-target="#deleteModal" 
                                    data-pet-id="@pet.IdPet" data-pet-name="@pet.PetName">
                                <i class="bi bi-trash"></i> Delete
                            </button>
                        </div>
                    </div>
                </div>
            }
        }
        else
        {
            <div class="col-12">
                <div class="alert alert-info">No pets found.</div>
            </div>
        }
    </div>

    <!-- Table View -->
    <div id="tableView" style="display: none;">
        <div class="table-responsive">
            <table class="table pet-table">
    <thead>
        <tr>
            <th>Id</th>
            <th>Avatar</th>
            <th>Pet Name</th>
            <th>Pet Type</th>
            <th>Age</th>
            <th>Sex</th>
            <th>Weight</th>
            <th>Height</th>
            <th>Identification</th>
            <th>Owner</th>
            <th>Veterinarian</th>
            <th>Created Date</th>
            <th class="text-center" style="width: 100px;">Actions</th>
        </tr>
    </thead>
    <tbody>
        @if (Model != null && Model.Count > 0)
        {
            foreach (var pet in Model)
            {
                <tr data-pet-id="@pet.IdPet" class="pet-table-row">
                    <td>@pet.IdPet</td>
                    <td>
                        <img src="@(string.IsNullOrEmpty(pet.Img) ? "/img/default-pet.jpg" : pet.Img)" alt="Pet Image" width="50" height="50" style="object-fit: cover; border-radius: 50%;" />
                    </td>
                    <td>@pet.PetName</td>
                    <td>@pet.PetType</td>
                    <td>@pet.Age</td>
                    <td>@pet.Sex</td>
                    <td>@pet.Weight</td>
                    <td>@pet.Height</td>
                    <td>@pet.Identification</td>
                    <td>@(pet.OwnerUser != null ? pet.OwnerUser.FullName : "-")</td>
                    <td>@(pet.VetUser != null ? pet.VetUser.FullName : "-")</td>
					<td>@pet.CreatedAt</td>
                    <td class="text-center" style="width: 250px;">
                        <div class="d-flex align-items-center justify-content-center">
                            <a href="@Url.Action("Edit", "Pet", new { id = pet.IdPet })" class="btn btn-sm btn-warning me-1">
                                <i class="bi bi-pencil-square"></i> Edit
                            </a>
                            <a href="@Url.Action("Delete", "Pet", new { id = pet.IdPet })"
                               class="btn btn-sm btn-danger me-2"
                               onclick="return confirm('Are you sure you want to delete this pet?');">
                                <i class="bi bi-trash"></i> Delete
                            </a>
                            <button type="button" class="table-toggle-arrow js-toggle-row" data-pet-id="@pet.IdPet">
                                <i class="bi bi-chevron-right"></i>
                            </button>
                        </div>
                    </td>
                </tr>
                <tr id="expanded-row-@pet.IdPet" class="expanded-row" style="display: none;">
                    <td colspan="13">
                        <div class="expanded-content">
                            <div class="expanded-section">
                                <div class="expanded-section-title">
                                    <i class="bi bi-info-circle"></i> Pet Details
                                </div>
                                <div class="expanded-pet-details">
                                    <div class="detail-item">
                                        <span class="detail-label">Age:</span>
                                        <span class="detail-value">@(pet.Age )</span>
                                    </div>
                                    <div class="detail-item">
                                        <span class="detail-label">Height:</span>
                                        <span class="detail-value">@(pet.Height )</span>
                                    </div>
                                    <div class="detail-item">
                                        <span class="detail-label">Identification:</span>
                                        <span class="detail-value">@(pet.Identification ?? "Not specified")</span>
                                    </div>
                                    <div class="detail-item">
                                        <span class="detail-label">Created:</span>
                                        <span class="detail-value">@pet.CreatedAt.ToString("yyyy-MM-dd")</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="expanded-section">
                                <div class="expanded-section-title">
                                    <i class="bi bi-calendar-check"></i> Appointments (@(pet.Appointments != null ? pet.Appointments.Count : 0))
                                </div>
                                <div class="expanded-appointments">
                                    @if (pet.Appointments != null && pet.Appointments.Count > 0)
                                    {
                                        foreach (var appointment in pet.Appointments.OrderBy(a => a.Time))
                                        {
                                            <div class="pet-appointment-item">
                                                <div class="pet-appointment-info">
                                                    <p class="pet-appointment-time">@appointment.Time</p>
                                                    <p class="pet-appointment-vet">Vet: @(appointment.VetUser?.FullName ?? "Not specified")</p>
                                                </div>
                                                <span class="pet-badge @(appointment.IsConfirmed == 1 ? "pet-badge-success" : "pet-badge-primary")">
                                                    @(appointment.IsConfirmed == 1 ? "Confirmed" : "Pending")
                                                </span>
                                                <div class="pet-appointment-tooltip">
                                                    <div class="pet-tooltip-header">Appointment Details</div>
                                                    <div class="pet-tooltip-info">
                                                        <p><strong>Date/Time:</strong> @appointment.Time</p>
                                                        <p><strong>Veterinarian:</strong> @(appointment.VetUser?.FullName ?? "Not specified")</p>
                                                        <p><strong>Status:</strong> @(appointment.IsConfirmed == 1 ? "Confirmed" : "Pending")</p>
                                                        <p><strong>ID:</strong> @appointment.IdAppointment</p>
                                                    </div>
                                                </div>
                                            </div>
                                        }
                                    }
                                    else
                                    {
                                        <p class="text-muted">No appointments scheduled.</p>
                                    }
                                </div>
                            </div>
                            
                            <div class="expanded-section">
                                <div class="expanded-section-title">
                                    <i class="bi bi-capsule"></i> Meds (@(pet.Meds != null ? pet.Meds.Count : 0))
                                </div>
                                <div class="expanded-medicines">
                                    @if (pet.Meds != null && pet.Meds.Count > 0)
                                    {
                                        foreach (var medicine in pet.Meds.OrderByDescending(m => m.CreatedAt))
                                        {
                                            <div class="pet-medicine-item">
                                                <div class="pet-medicine-info">
                                                    <p class="pet-medicine-name">@medicine.MedName</p>
                                                    <p class="pet-medicine-dose">Dose: @medicine.Dose</p>
                                                </div>
                                                <div class="pet-medicine-tooltip">
                                                    <div class="pet-tooltip-header">Medicine Details</div>
                                                    <div class="pet-tooltip-info">
                                                        <p><strong>Name:</strong> @medicine.MedName</p>
                                                        <p><strong>Dose:</strong> @medicine.Dose</p>
                                                        <p><strong>Amount:</strong> @medicine.Amount</p>
                                                        <p><strong>Total:</strong> @medicine.Total</p>
                                                        <p><strong>Notice:</strong> @(medicine.Notice ?? "None")</p>
                                                        <p><strong>Prescribed by:</strong> @(medicine.VetUser?.FullName ?? "Not specified")</p>
                                                    </div>
                                                </div>
                                            </div>
                                        }
                                    }
                                    else
                                    {
                                        <p class="text-muted">No medicines prescribed.</p>
                                    }
                                </div>
                            </div>
                            
                            <div class="expanded-section">
                                <div class="expanded-section-title">
                                    <i class="bi bi-shield-check"></i> Vacs (@(pet.Vacs != null ? pet.Vacs.Count : 0))
                                </div>
                                <div class="expanded-vaccines">
                                    @if (pet.Vacs != null && pet.Vacs.Count > 0)
                                    {
                                        foreach (var vaccine in pet.Vacs.OrderByDescending(v => v.Date))
                                        {
                                            <div class="pet-vaccine-item">
                                                <div class="pet-vaccine-info">
                                                    <p class="pet-vaccine-name">@vaccine.VacName</p>
                                                    <p class="pet-vaccine-date">Date: @(vaccine.Date?.ToString("yyyy-MM-dd") ?? "Not specified")</p>
                                                </div>
                                                <div class="pet-vaccine-tooltip">
                                                    <div class="pet-tooltip-header">Vaccine Details</div>
                                                    <div class="pet-tooltip-info">
                                                        <p><strong>Name:</strong> @vaccine.VacName</p>
                                                        <p><strong>Date:</strong> @(vaccine.Date?.ToString("yyyy-MM-dd") ?? "Not specified")</p>
                                                        <p><strong>Dose:</strong> @vaccine.Dose</p>
                                                        <p><strong>Total:</strong> @vaccine.Total</p>
                                                        <p><strong>Administered by:</strong> @(vaccine.VetUser?.FullName ?? "Not specified")</p>
                                                    </div>
                                                </div>
                                            </div>
                                        }
                                    }
                                    else
                                    {
                                        <p class="text-muted">No vaccines administered.</p>
                                    }
                                </div>
                            </div>
                        </div>
                    </td>
                </tr>
            }
        }
        else
        {
            <tr>
                <td colspan="12" class="text-center">No pet found.</td>
            </tr>
        }
    </tbody>
</table>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header pet-modal-header">
                <h5 class="modal-title" id="deleteModalLabel">Confirm Delete</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p id="deleteConfirmationText">Are you sure you want to delete this pet?</p>
                <form id="deleteForm" method="post">
                    <input type="hidden" id="petIdToDelete" name="id" />
                </form>
            </div>
            <div class="modal-footer pet-modal-footer">
                <button type="button" class="btn pet-btn pet-btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" id="confirmDelete" class="btn pet-btn pet-btn-danger" onclick="document.getElementById('deleteForm').submit();">Delete</button>
            </div>
        </div>
    </div>
</div>

<!-- Avatar Modal -->
<div id="avatarModal" class="avatar-modal">
    <span class="avatar-modal-close">&times;</span>
    <img class="avatar-modal-content" id="modalAvatarImage">
</div>

@if (TempData["SuccessMessage"] != null)
{
    <div class="toast-container position-fixed top-0 end-0 p-3">
        <div id="successToast" class="toast align-items-center text-bg-success border-0" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="d-flex">
                <div class="toast-body">
                    @TempData["SuccessMessage"]
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
        </div>
    </div>
}

@section Scripts {
    <script src="~/js/pet.js"></script>
}
