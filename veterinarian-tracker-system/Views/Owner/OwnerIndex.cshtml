@model List<TuyetDang.MyVetTracer.Entity.Owner>

@{
    ViewData["Title"] = "Owner List";
}

@section Styles {
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="~/css/owner.css" />
}

<div class="owner-container fade-in">
    <div class="owner-header">
        <h2><i class="bi bi-people"></i> Owners Management</h2>
        <a href="@Url.Action("Create", "Owner")" class="btn owner-btn owner-btn-success">
            <i class="bi bi-plus-circle"></i> Add New Owner
        </a>
    </div>

    <!-- Dashboard Stats -->
    <div class="owner-stats-container mb-4">
        <div class="row g-3">
            <div class="col-md-4">
                <div class="owner-stat-card bg-primary text-white">
                    <div class="owner-stat-icon"><i class="bi bi-people-fill"></i></div>
                    <div class="owner-stat-info">
                        <h3>@Model.Count</h3>
                        <p>Total Owners</p>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="owner-stat-card bg-success text-white">
                    <div class="owner-stat-icon"><i class="bi bi-heart-fill"></i></div>
                    <div class="owner-stat-info">
                        <h3>@Model.Sum(o => o.Pets != null ? o.Pets.Count : 0)</h3>
                        <p>Total Pets</p>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="owner-stat-card bg-info text-white">
                    <div class="owner-stat-icon"><i class="bi bi-calendar-check"></i></div>
                    <div class="owner-stat-info">
                        <h3>@Model.Where(o => o.CreatedAt.Date == DateTime.Today.Date).Count()</h3>
                        <p>New Today</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Search and Filter Section -->
    <div class="owner-search-container mb-4">
        <form id="filterForm" method="get" action="@Url.Action("OwnerIndex", "Owner")" class="row g-3">
            <div class="col-md-4">
                <div class="input-group">
                    <span class="input-group-text"><i class="bi bi-search"></i></span>
                    <input type="text" class="form-control" placeholder="Search by name, email..." name="searchString" value="@ViewBag.CurrentFilter">
                </div>
            </div>
            <div class="col-md-3">
                <select class="form-select" name="sortOrder">
                    <option value="">Sort by...</option>
                    <option value="name_asc">Name (A-Z)</option>
                    <option value="name_desc">Name (Z-A)</option>
                    <option value="date_asc">Date (Oldest)</option>
                    <option value="date_desc">Date (Newest)</option>
                    <option value="pets_asc">Pets (Fewest)</option>
                    <option value="pets_desc">Pets (Most)</option>
                </select>
            </div>
            <div class="col-md-3">
                <button type="submit" class="btn owner-btn owner-btn-primary w-100"><i class="bi bi-filter"></i> Apply Filters</button>
            </div>
            <div class="col-md-2">
                <button type="button" id="resetFilters" class="btn owner-btn owner-btn-outline-secondary w-100"><i class="bi bi-x-circle"></i> Reset</button>
            </div>
        </form>
    </div>

    <!-- View Toggle Buttons -->
    <div class="mb-4">
        <div class="btn-group" role="group">
            <button id="cardViewBtn" type="button" class="btn owner-btn owner-btn-outline-primary active">
                <i class="bi bi-grid-3x3-gap"></i> Card View
            </button>
            <button id="tableViewBtn" type="button" class="btn owner-btn owner-btn-outline-primary">
                <i class="bi bi-table"></i> Table View
            </button>
        </div>
    </div>

    <!-- Card View -->
    <div id="cardView" class="row g-4 mb-4">
        @if (Model != null && Model.Count > 0)
        {
            foreach (var owner in Model)
            {
                <div class="col-md-6 col-lg-4">
                    <div class="owner-card">
                        <div class="owner-card-header">
                            <h5>@owner.FullName</h5>
                            <p class="text-muted">@owner.UserName</p>
                        </div>
                        <div class="owner-card-img text-center">
                            <img src="@owner.Img" alt="@owner.FullName" class="owner-avatar-img">
                        </div>
                        <div class="owner-card-body">
                            <div class="mb-3">
                                <p><i class="bi bi-envelope"></i> @owner.Email</p>
                                <p><i class="bi bi-telephone"></i> @owner.PhoneNum</p>
                                <p><i class="bi bi-calendar"></i> @(owner.Dob.HasValue ? owner.Dob.Value.ToString("yyyy-MM-dd") : "-")</p>
                                <p><i class="bi bi-gender-ambiguous"></i> @owner.Gender</p>
                            </div>
                            
                            <div class="mb-3">
                                <button class="pet-toggle-btn" data-target="petSection-@owner.IdOwnerUser">
                                    <i class="bi bi-chevron-right"></i> Pets (@(owner.Pets != null ? owner.Pets.Count : 0))
                                </button>
                                <div id="petSection-@owner.IdOwnerUser" class="pet-toggle-section">
                                    @if (owner.Pets != null && owner.Pets.Count > 0)
                                    {
                                        <div class="pet-toggle-content">
                                            @foreach (var pet in owner.Pets)
                                            {
                                                <div class="pet-item">
                                                    <img src="@pet.Img" alt="@pet.PetName" class="pet-item-img">
                                                    <div class="pet-item-info">
                                                        <h6>@pet.PetName</h6>
                                                        <p>@pet.PetType, @pet.Age years, @pet.Sex</p>
                                                    </div>
                                                </div>
                                            }
                                        </div>
                                    }
                                    else
                                    {
                                        <div class="pet-toggle-content">
                                            <p class="text-muted">No pets registered</p>
                                        </div>
                                    }
                                </div>
                            </div>
                        </div>
                        <div class="owner-card-footer">
                            <a href="@Url.Action("Edit", "Owner", new { id = owner.IdOwnerUser })" class="btn owner-btn owner-btn-warning me-1">
                                <i class="bi bi-pencil-square"></i> Edit
                            </a>
                            <button class="btn owner-btn owner-btn-danger delete-owner-btn" data-bs-toggle="modal" data-bs-target="#deleteModal" 
                                    data-owner-id="@owner.IdOwnerUser" data-owner-name="@owner.FullName">
                                <i class="bi bi-trash"></i> Delete
                            </button>
                        </div>
                    </div>
                </div>
            }
        }
        else
        {
            <div class="col-12">
                <div class="alert alert-info">No owners found.</div>
            </div>
        }
    </div>

    <!-- Table View -->
    <div id="tableView" style="display: none;">
        <div class="table-responsive">
            <table class="table owner-table">
                <thead>
                    <tr>
                        <th scope="col">Avatar</th>
                        <th scope="col">Name</th>
                        <th scope="col">Email</th>
                        <th scope="col">Phone</th>
                        <th scope="col">Gender</th>
                        <th scope="col">Pets</th>
                        <th scope="col">Status</th>
                        <th scope="col" class="text-center">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    @if (Model != null && Model.Count > 0)
                    {
                        foreach (var owner in Model)
                        {
                            <tr class="owner-row" data-owner-id="@owner.IdOwnerUser">
                                <td>
                                    <img src="@owner.Img" alt="@owner.FullName" class="owner-avatar-img table-avatar" data-img-src="@owner.Img">
                                </td>
                                <td>
                                    <div class="fw-bold">@owner.FullName</div>
                                    <div class="text-muted small">@owner.UserName</div>
                                </td>
                                <td>@owner.Email</td>
                                <td>@owner.PhoneNum</td>
                                <td>@owner.Gender</td>
                                <td>
                                    <span class="badge bg-info rounded-pill">@(owner.Pets != null ? owner.Pets.Count : 0) pets</span>
                                </td>
                                <td>
                                    <span class="badge bg-success">Active</span>
                                </td>
                                <td class="text-center">
                                    <div class="btn-group">
                                        <a href="@Url.Action("Edit", "Owner", new { id = owner.IdOwnerUser })" class="btn owner-btn owner-btn-warning btn-sm">
                                            <i class="bi bi-pencil-square"></i>
                                        </a>
                                        <button class="btn owner-btn owner-btn-danger btn-sm delete-owner-btn" data-bs-toggle="modal" data-bs-target="#deleteModal"
                                                data-owner-id="@owner.IdOwnerUser" data-owner-name="@owner.FullName">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                        <button class="btn owner-btn owner-btn-primary btn-sm toggle-row-btn" data-owner-id="@owner.IdOwnerUser">
                                            <i class="bi bi-chevron-down"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            <tr id="expanded-row-@owner.IdOwnerUser" class="owner-expanded-row" style="display: none;">
                                <td colspan="8">
                                    <div class="owner-expanded-content">
                                        <div class="expanded-section">
                                            <div class="expanded-section-title">
                                                <i class="bi bi-person-badge"></i> Owner Details
                                            </div>
                                            <div class="owner-details-grid">
                                                <div><strong>ID:</strong> @owner.IdOwnerUser</div>
                                                <div><strong>Username:</strong> @owner.UserName</div>
                                                <div><strong>Date of Birth:</strong> @(owner.Dob.HasValue ? owner.Dob.Value.ToString("yyyy-MM-dd") : "-")</div>
                                                <div><strong>Created:</strong> @owner.CreatedAt.ToString("yyyy-MM-dd")</div>
                                            </div>
                                        </div>
                                        
                                        <div class="expanded-section">
                                            <div class="expanded-section-title">
                                                <i class="bi bi-heart"></i> Pets (@(owner.Pets != null ? owner.Pets.Count : 0))
                                            </div>
                                            <div class="expanded-pets">
                                                @if (owner.Pets != null && owner.Pets.Count > 0)
                                                {
                                                    foreach (var pet in owner.Pets)
                                                    {
                                                        <div class="owner-pet-item">
                                                            <img src="@(string.IsNullOrEmpty(pet.Img) ? "/img/default-pet.jpg" : pet.Img)" alt="@pet.PetName" class="owner-pet-img" />
                                                            <div class="owner-pet-info">
                                                                <p class="owner-pet-name">@pet.PetName</p>
                                                                <p class="owner-pet-type">@pet.PetType, @pet.Age years old</p>
                                                            </div>
                                                            <div class="owner-pet-tooltip">
                                                                <div class="owner-tooltip-header">@pet.PetName</div>
                                                                <div class="owner-tooltip-info">
                                                                    <p><strong>Type:</strong> @pet.PetType</p>
                                                                    <p><strong>Age:</strong> @pet.Age years</p>
                                                                    <p><strong>Sex:</strong> @pet.Sex</p>
                                                                    <p><strong>Weight:</strong> @pet.Weight kg</p>
                                                                    <p><strong>Height:</strong> @pet.Height cm</p>
                                                                    <p><strong>ID:</strong> @pet.Identification</p>
                                                                </div>
                                                            </div>
                                                        </div>
                                                        
                                                        @if (pet.Appointments != null && pet.Appointments.Count > 0)
                                                        {
                                                            <div class="pet-appointments">
                                                                <h6><i class="bi bi-calendar-check"></i> Appointments for @pet.PetName</h6>
                                                                <div class="pet-appointments-list">
                                                                    @foreach (var appointment in pet.Appointments.OrderBy(a => a.Time))
                                                                    {
                                                                        <div class="owner-appointment-item">
                                                                            <div class="owner-appointment-info">
                                                                                <p class="owner-appointment-time">@appointment.Time</p>
                                                                                <p class="owner-appointment-vet">Vet: @(appointment.VetUser?.FullName ?? "Not specified")</p>
                                                                            </div>
                                                                            <span class="owner-badge @(appointment.IsConfirmed == 1 ? "owner-badge-success" : "owner-badge-primary")">
                                                                                @(appointment.IsConfirmed == 1 ? "Confirmed" : "Pending")
                                                                            </span>
                                                                            <div class="owner-appointment-tooltip">
                                                                                <div class="owner-tooltip-header">Appointment Details</div>
                                                                                <div class="owner-tooltip-info">
                                                                                    <p><strong>Date/Time:</strong> @appointment.Time</p>
                                                                                    <p><strong>Vet:</strong> @(appointment.VetUser?.FullName ?? "Not specified")</p>
                                                                                    <p><strong>Status:</strong> @(appointment.IsConfirmed == 1 ? "Confirmed" : "Pending")</p>
                                                                                    <p><strong>ID:</strong> @appointment.IdAppointment</p>
                                                                                </div>
                                                                            </div>
                                                                        </div>
                                                                    }
                                                                </div>
                                                            </div>
                                                        }
                                                    }
                                                }
                                                else
                                                {
                                                    <p class="text-muted">No pets registered.</p>
                                                }
                                            </div>
                                        </div>
                                    </div>
                                </td>
                            </tr>
                        }
                    }
                    else
                    {
                        <tr>
                            <td colspan="8" class="text-center">No owners found.</td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>

    <!-- Pagination -->
    @if (ViewBag.TotalPages > 1)
    {
        <nav aria-label="Page navigation" class="owner-pagination">
            <ul class="pagination">
                <!-- Previous Page -->
                <li class="page-item @(!ViewBag.HasPreviousPage ? "disabled" : "")">
                    <a class="page-link"
                        href="@Url.Action("OwnerIndex", new { searchString = ViewBag.CurrentFilter, sortOrder = ViewBag.CurrentSort, page = ViewBag.CurrentPage - 1 })"
                        tabindex="-1" aria-disabled="@(!ViewBag.HasPreviousPage)">
                        <i class="bi bi-chevron-left"></i> Previous
                    </a>
                </li>

                <!-- Page Numbers -->
                @{
                    int startPage = Math.Max(1, ViewBag.CurrentPage - 2);
                    int endPage = Math.Min(ViewBag.TotalPages, startPage + 4);

                    // Adjust start page if we're near the end
                    if (endPage - startPage < 4 && startPage > 1)
                    {
                        startPage = Math.Max(1, endPage - 4);
                    }
                }

                @for (int i = startPage; i <= endPage; i++)
                {
                    <li class="page-item @(i == ViewBag.CurrentPage ? "active" : "")">
                        <a class="page-link"
                            href="@Url.Action("OwnerIndex", new { searchString = ViewBag.CurrentFilter, sortOrder = ViewBag.CurrentSort, page = i })">
                            @i
                        </a>
                    </li>
                }

                <!-- Next Page -->
                <li class="page-item @(!ViewBag.HasNextPage ? "disabled" : "")">
                    <a class="page-link"
                        href="@Url.Action("OwnerIndex", new { searchString = ViewBag.CurrentFilter, sortOrder = ViewBag.CurrentSort, page = ViewBag.CurrentPage + 1 })">
                        Next <i class="bi bi-chevron-right"></i>
                    </a>
                </li>
            </ul>
        </nav>
    }

    <!-- Results Summary -->
    <div class="owner-results-summary text-muted mb-3">
        <small>Showing page @ViewBag.CurrentPage of @ViewBag.TotalPages (@ViewBag.TotalOwners total records)</small>
    </div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header owner-modal-header">
                <h5 class="modal-title" id="deleteModalLabel">Confirm Delete</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p id="deleteConfirmationText">Are you sure you want to delete this owner?</p>
                <form id="deleteForm" method="post">
                    <input type="hidden" id="ownerIdToDelete" name="id" />
                </form>
            </div>
            <div class="modal-footer owner-modal-footer">
                <button type="button" class="btn owner-btn owner-btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" id="confirmDelete" class="btn owner-btn owner-btn-danger" onclick="document.getElementById('deleteForm').submit();">Delete</button>
            </div>
        </div>
    </div>
</div>

<!-- Avatar Modal -->
<div id="avatarModal" class="avatar-modal">
    <span class="avatar-modal-close">&times;</span>
    <img class="avatar-modal-content" id="avatarModalImg">
</div>

@if (TempData["SuccessMessage"] != null)
{
    <div class="toast-container position-fixed top-0 end-0 p-3">
        <div id="successToast" class="toast align-items-center text-bg-success border-0" role="alert" aria-live="assertive"
            aria-atomic="true">
            <div class="d-flex">
                <div class="toast-body">
                    @TempData["SuccessMessage"]
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"
                    aria-label="Close"></button>
            </div>
        </div>
    </div>

    <script type="text/javascript">
        window.onload = function () {
            var toastEl = document.getElementById('successToast');
            if (toastEl) {
                var toast = new bootstrap.Toast(toastEl);
                toast.show();
            }
        };
    </script>
}

@section Scripts {
    <script src="~/js/owner.js"></script>
}